/*! qajax 0.2.6 - Simple Promise ajax library based on Q */
!function(a){"object"==typeof exports?module.exports=a(require("q")):"function"==typeof define&&define.amd?define(["q"],a):window.Qajax=a(window.Q)}(function(a){"use strict";function b(){}function c(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c.join("&")}function d(a){return-1===a.indexOf("?")}function e(b,e){if(0===arguments.length)throw new Error("Qajax: settings are required");var f;if("string"==typeof b)f="object"==typeof e&&e||{},f.url=b;else{if("object"!=typeof b)throw new Error("Qajax: settings must be an object");f=b}if(!f.url)throw new Error("Qajax: settings.url is required");if("cancellation"in f&&!a.isPromiseAlike(f.cancellation))throw new Error("cancellation must be a Promise.");this.params={};for(var h in f)this[h]=f[h];var i=this.params,j=this.cache;j&&(i[j===!0?"_":j]=(new Date).getTime());var k=(this.base||"")+this.url,l=c(i);l&&(k=k+(d(k)?"?":"&")+l),this.url=k;var m=this.data,n=this.headers;null!==m&&"object"==typeof m&&(g in n||(n[g]="application/json"),this.data=JSON.stringify(m));var o=this._send,p=this;this.send=function(){return a.fcall(function(){return o.call(p)})}}function f(a,b){return new e(a,b).send()}var g="Content-Type",h=a.defer().promise;return e.prototype={log:b,timeout:6e4,cache:!!(window.ActiveXObject||"ActiveXObject"in window),method:"GET",headers:{},base:"",withCredentials:!1,cancellation:h,_send:function(){var b=new window.XMLHttpRequest,c=a.defer(),d=this.log,e=this.method,f=this.url;b.onreadystatechange=function(){if(4===b.readyState)try{d(e+" "+f+" => "+b.status),b.status?c.resolve(b):c.reject(b)}catch(a){c.reject(b)}},b.onprogress=function(a){c.notify(a)},b.open(e,f,!0),this.responseType&&(b.responseType=this.responseType);var g=this.headers;for(var h in g)g.hasOwnProperty(h)&&b.setRequestHeader(h,g[h]);this.withCredentials&&(b.withCredentials=!0);var i=this.data;return void 0!==i&&null!==i?b.send(i):b.send(),this.cancellation.fin(function(){c.promise.isFulfilled()||(d("Qajax cancellation reached."),b.abort())}),this.timeout?c.promise.timeout(this.timeout).fail(function(a){throw a instanceof Error&&(d("Qajax request delay reach in "+e+" "+f),b.abort()),b}):c.promise}},f.defaults=e.prototype,f.Builder=e,f.filterStatus=function(b){var c,d,e=this.log;if(d=typeof b,"function"===d)c=b;else{if("number"!==d)throw"validStatus type "+d+" unsupported";c=function(a){return a===b}}return function(b){var d=0;try{d=b.status}catch(f){e("Qajax: failed to read xhr.status")}return 1223===d&&(d=204),c(d)?a.resolve(b):a.reject(b)}},f.filterSuccess=f.filterStatus(function(a){return a>=200&&300>a||304===a}),f.toJSON=function(b){return a.fcall(function(){return JSON.parse(b.responseText)})},f.getJSON=function(a){return f({url:a,method:"GET"}).then(f.filterSuccess).then(f.toJSON)},f.serialize=c,f});